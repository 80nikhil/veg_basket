<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard - Order History</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        background: #f3f6f9;
        margin: 0;
        padding: 24px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #1f4d3f;
      }
      .order-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
        margin-bottom: 16px;
        padding: 16px;
      }
      .order-head {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: center;
      }
      .order-meta {
        font-size: 0.95rem;
        color: #334155;
      }
      .user-box {
        font-size: 0.9rem;
        color: #0f172a;
      }
      details {
        margin-top: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        text-align: left;
        padding: 8px 6px;
        border-bottom: 1px solid #eef2f7;
      }
      th {
        color: #0f172a;
        font-weight: 600;
      }
      .badge {
        background: #e6fffa;
        color: #065f46;
        padding: 6px 8px;
        border-radius: 6px;
        font-weight: 600;
      }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }
      .filters {
        display: flex;
        gap: 8px;
      }
      .small {
        font-size: 0.85rem;
        color: #475569;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <h1>Order History (Admin)</h1>
        <div class="filters">
          <form
            method="get"
            id="filterForm"
            style="display: flex; gap: 8px; align-items: center"
          >
            <label class="small"
              >Start:
              <input
                type="date"
                name="start_date"
                value="{{ filters.start_date }}"
            /></label>
            <label class="small"
              >End:
              <input type="date" name="end_date" value="{{ filters.end_date }}"
            /></label>
            <label class="small"
              >Month:
              <input type="month" name="month" value="{{ filters.month }}"
            /></label>
            <label class="small"
              >Sort:
              <select name="sort_by">
                <option
                  value="created_at"
                  {%
                  if
                  filters.sort_by=""
                  ="created_at"
                  %}selected{%
                  endif
                  %}
                >
                  Date
                </option>
                <option
                  value="total_amount"
                  {%
                  if
                  filters.sort_by=""
                  ="total_amount"
                  %}selected{%
                  endif
                  %}
                >
                  Amount
                </option>
              </select>
            </label>
            <label class="small"
              >Order:
              <select name="order">
                <option
                  value="desc"
                  {%
                  if
                  filters.order=""
                  ="desc"
                  %}selected{%
                  endif
                  %}
                >
                  Desc
                </option>
                <option
                  value="asc"
                  {%
                  if
                  filters.order=""
                  ="asc"
                  %}selected{%
                  endif
                  %}
                >
                  Asc
                </option>
              </select>
            </label>
            <button
              type="submit"
              style="
                padding: 8px 12px;
                border-radius: 6px;
                background: #10b981;
                color: white;
                border: none;
              "
            >
              Apply
            </button>
            <button
              type="button"
              id="exportBtn"
              style="
                padding: 8px 12px;
                border-radius: 6px;
                background: #2563eb;
                color: white;
                border: none;
                margin-left: 8px;
              "
            >
              Export CSV
            </button>
            <button
              type="button"
              id="resetBtn"
              style="
                padding: 8px 12px;
                border-radius: 6px;
                background: #ef4444;
                color: white;
                border: none;
                margin-left: 8px;
              "
            >
              Reset
            </button>
          </form>
        </div>
      </div>

      <div style="margin: 12px 0; font-weight: 700">
        Total month sales: ₹ {{ total_month }}
      </div>

      <script>
        // Build export by submitting form with export=csv param
        (function () {
          const filterForm = document.getElementById("filterForm");
          const exportBtn = document.getElementById("exportBtn");
          const resetBtn = document.getElementById("resetBtn");
          if (exportBtn) {
            exportBtn.addEventListener("click", function () {
              // append export param and submit
              const input = document.createElement("input");
              input.type = "hidden";
              input.name = "export";
              input.value = "csv";
              filterForm.appendChild(input);
              filterForm.submit();
            });
          }
          if (resetBtn) {
            resetBtn.addEventListener("click", function () {
              window.location.href = window.location.pathname;
            });
          }
        })();
      </script>

      {% if orders %}
      <div class="order-card">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>User</th>
              <th>Contact</th>
              <th>Society</th>
              <th>Address</th>
              <th>Delivery</th>
              <th>Items</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr>
              <td>{{ o.order_id }}</td>
              <td>{{ o.created_at }}</td>
              <td>{{ o.user.username }}</td>
              <td>{{ o.user.contact_no }}</td>
              <td>{{ o.society }}</td>
              <td>{{ o.address }}</td>
              <td>{{ o.delivery_date }}<br />{{ o.delivery_slot }}</td>
              <td>
                <button
                  class="view-items-btn"
                  data-items="{{ o.items_json|safe }}"
                  style="
                    padding: 6px 8px;
                    border-radius: 6px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                  "
                >
                  View Items
                </button>
              </td>
              <td>₹ {{ o.total_amount }}</td>
              <td>{{ o.order_status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p>No orders found.</p>
      {% endif %}

      <!-- Modal -->
      <div
        id="itemsModal"
        style="
          display: none;
          position: fixed;
          inset: 0;
          background: rgba(2, 6, 23, 0.6);
          align-items: center;
          justify-content: center;
        "
      >
        <div
          style="
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            padding: 16px;
            max-height: 80%;
            overflow: auto;
          "
        >
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h3 style="margin: 0">Order Items</h3>
            <button
              id="closeModal"
              style="
                background: #ef4444;
                color: white;
                border: none;
                padding: 6px 10px;
                border-radius: 6px;
              "
            >
              Close
            </button>
          </div>
          <div id="modalBody" style="margin-top: 12px"></div>
        </div>
      </div>

      <script>
        // existing export/reset script above remains
        (function () {
          // Modal logic for view items with robust parsing
          const modal = document.getElementById("itemsModal");
          const modalBody = document.getElementById("modalBody");
          const closeModal = document.getElementById("closeModal");

          function openModal(items) {
            modalBody.innerHTML = "";
            const table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            const thead = document.createElement("thead");
            thead.innerHTML =
              '<tr><th style="text-align:left;padding:8px">Product</th><th style="text-align:left;padding:8px">Unit</th><th style="text-align:left;padding:8px">Price</th><th style="text-align:left;padding:8px">Quantity</th></tr>';
            table.appendChild(thead);
            const tbody = document.createElement("tbody");
            (items || []).forEach(function (it) {
              const tr = document.createElement("tr");
              tr.innerHTML = `<td style="padding:8px">${it.name || ""}</td><td style="padding:8px">${it.unit || ""}</td><td style="padding:8px">₹ ${it.price || ""}</td><td style="padding:8px">${it.quantity || ""}</td>`;
              tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            modalBody.appendChild(table);
            modal.style.display = "flex";
          }

          function tryParseData(raw) {
            if (!raw) return [];
            // 1) direct JSON.parse
            try {
              return JSON.parse(raw);
            } catch (e) {}
            // 2) try decodeURIComponent then parse
            try {
              return JSON.parse(decodeURIComponent(raw));
            } catch (e) {}
            // 3) replace HTML entities for quotes and parse
            try {
              const replaced = raw
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");
              return JSON.parse(replaced);
            } catch (e) {}
            // 4) last resort: attempt eval guarded (not ideal) — return empty
            return [];
          }

          document.querySelectorAll(".view-items-btn").forEach(function (btn) {
            btn.addEventListener("click", function () {
              const raw = this.getAttribute("data-items");
              const items = tryParseData(raw);
              openModal(items);
            });
          });

          closeModal.addEventListener("click", function () {
            modal.style.display = "none";
          });
          modal.addEventListener("click", function (e) {
            if (e.target == modal) modal.style.display = "none";
          });
        })();
      </script>
    </div>
  </body>
</html>
